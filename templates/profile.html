{% extends "base.html" %}

{% block title %}Profile - SmartEdu AI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user me-2"></i>My Profile</h5>
            </div>
            <div class="card-body">
                <form id="profileForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" value="{{ current_user.username }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Role</label>
                            <input type="text" class="form-control" value="{{ current_user.role|title }}" readonly>
                        </div>
                    </div>
                    
                    {% if current_user.student_profile %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Student ID</label>
                            <input type="text" class="form-control" value="{{ current_user.student_profile.student_id }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" value="{{ current_user.student_profile.first_name }}" readonly>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" value="{{ current_user.student_profile.last_name }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" value="{{ current_user.email }}">
                        </div>
                    </div>
                    
                    {% if current_user.student_profile %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" value="{{ current_user.student_profile.date_of_birth }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gender</label>
                            <input type="text" class="form-control" value="{{ current_user.student_profile.gender }}" readonly>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if current_user.student_profile %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" value="{{ current_user.student_profile.phone }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Enrollment Date</label>
                            <input type="date" class="form-control" value="{{ current_user.student_profile.enrollment_date }}" readonly>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if current_user.student_profile %}
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" rows="3" readonly>{{ current_user.student_profile.address or '' }}</textarea>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" onclick="updateProfile()">
                                <i class="fas fa-save me-2"></i>Update Profile
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateProfile() {
    const form = document.getElementById('profileForm');
    const formData = new FormData();
    
    // Add form data
    const email = document.getElementById('email').value;
    formData.append('email', email);
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="button"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
    }
    
    // Send update request
    fetch('/api/update_profile', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(response => {
        if (response.success) {
            showNotification('success', response.message || 'Profile updated successfully');
        } else {
            showNotification('error', response.message || 'Update failed');
        }
    })
    .catch(error => {
        console.error('Profile update error:', error);
        showNotification('error', 'Network error. Please try again.');
    })
    .finally(() => {
        // Reset button state
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Profile';
        }
    });
}
</script>
{% endblock %}
