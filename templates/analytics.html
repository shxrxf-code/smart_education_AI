{% extends "base.html" %}

{% block title %}Analytics - SmartEdu AI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-line me-2"></i>Academic Analytics</h2>
        <p class="text-muted">Comprehensive insights into student performance and institutional metrics.</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 class="mb-0">486</h4>
                <small>Total Students</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 class="mb-0">82%</h4>
                <small>Avg Attendance</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 class="mb-0">3.2</h4>
                <small>Avg GPA</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 class="mb-0">47</h4>
                <small>At-Risk Students</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4 class="mb-0">12%</h4>
                <small>Dropout Risk</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h4 class="mb-0">94%</h4>
                <small>Prediction Accuracy</small>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="semesterFilter">
                        <option value="all">All Semesters</option>
                        <option value="current">Current Semester</option>
                        <option value="last">Last Semester</option>
                    </select>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="departmentFilter">
                        <option value="all">All Departments</option>
                        <option value="cs">Computer Science</option>
                        <option value="eng">Engineering</option>
                        <option value="bus">Business</option>
                    </select>
                    <button class="btn btn-sm btn-primary" onclick="applyFilters()">
                        <i class="fas fa-search me-1"></i>Apply
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Date Range</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Risk Level</label>
                        <select class="form-select" id="riskLevelFilter">
                            <option value="all">All Levels</option>
                            <option value="high">High Risk</option>
                            <option value="medium">Medium Risk</option>
                            <option value="low">Low Risk</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Performance Range</label>
                        <select class="form-select" id="performanceFilter">
                            <option value="all">All Ranges</option>
                            <option value="excellent">Excellent (3.5+)</option>
                            <option value="good">Good (3.0-3.5)</option>
                            <option value="average">Average (2.5-3.0)</option>
                            <option value="poor">Poor (<2.5)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Performance Trends Over Time</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceTrendsChart" height="100"></canvas>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Department-wise Performance</h5>
            </div>
            <div class="card-body">
                <canvas id="departmentPerformanceChart" height="100"></canvas>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Prediction Accuracy Analysis</h5>
            </div>
            <div class="card-body">
                <canvas id="predictionAccuracyChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Risk Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="riskDistributionChart" height="200"></canvas>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-danger">High Risk</span>
                        <span>12 students</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-warning">Medium Risk</span>
                        <span>35 students</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-success">Low Risk</span>
                        <span>439 students</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>Grade Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="gradeDistributionChart" height="200"></canvas>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Attendance Impact</h5>
            </div>
            <div class="card-body">
                <canvas id="attendanceImpactChart" height="200"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-download me-2"></i>Export Reports</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="exportReport('performance')">
                        <i class="fas fa-file-excel me-2"></i>Performance Report
                    </button>
                    <button class="btn btn-outline-success" onclick="exportReport('attendance')">
                        <i class="fas fa-file-excel me-2"></i>Attendance Report
                    </button>
                    <button class="btn btn-outline-warning" onclick="exportReport('risk')">
                        <i class="fas fa-file-excel me-2"></i>Risk Analysis Report
                    </button>
                    <button class="btn btn-outline-info" onclick="exportReport('prediction')">
                        <i class="fas fa-file-excel me-2"></i>Prediction Accuracy Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detailed Analytics View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detailedAnalytics">
                    <!-- Detailed analytics will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportDetailedReport()">
                    <i class="fas fa-download me-1"></i>Export Detailed Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Performance Trends Chart
const performanceTrendsCtx = document.getElementById('performanceTrendsChart').getContext('2d');
const performanceTrendsChart = new Chart(performanceTrendsCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [{
            label: 'Average GPA',
            data: [3.1, 3.15, 3.12, 3.18, 3.2, 3.22, 3.25, 3.23, 3.2, 3.18, 3.21, 3.2],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }, {
            label: 'Attendance Rate',
            data: [78, 79, 80, 82, 81, 83, 82, 84, 83, 82, 81, 82],
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            tension: 0.1,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                min: 2.5,
                max: 4.0
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                min: 60,
                max: 100,
                grid: {
                    drawOnChartArea: false,
                },
            }
        }
    }
});

// Department Performance Chart
const departmentPerformanceCtx = document.getElementById('departmentPerformanceChart').getContext('2d');
const departmentPerformanceChart = new Chart(departmentPerformanceCtx, {
    type: 'bar',
    data: {
        labels: ['Computer Science', 'Engineering', 'Business', 'Arts', 'Science', 'Medicine'],
        datasets: [{
            label: 'Average GPA',
            data: [3.4, 3.2, 3.3, 3.1, 3.5, 3.6],
            backgroundColor: [
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: false,
                min: 2.5,
                max: 4.0
            }
        }
    }
});

// Prediction Accuracy Chart
const predictionAccuracyCtx = document.getElementById('predictionAccuracyChart').getContext('2d');
const predictionAccuracyChart = new Chart(predictionAccuracyCtx, {
    type: 'line',
    data: {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7', 'Week 8'],
        datasets: [{
            label: 'GPA Prediction Accuracy',
            data: [85, 87, 88, 90, 91, 92, 93, 94],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }, {
            label: 'Risk Prediction Accuracy',
            data: [82, 84, 86, 88, 89, 90, 91, 92],
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: false,
                min: 75,
                max: 100
            }
        }
    }
});

// Risk Distribution Chart
const riskDistributionCtx = document.getElementById('riskDistributionChart').getContext('2d');
const riskDistributionChart = new Chart(riskDistributionCtx, {
    type: 'doughnut',
    data: {
        labels: ['High Risk', 'Medium Risk', 'Low Risk'],
        datasets: [{
            data: [12, 35, 439],
            backgroundColor: [
                'rgba(220, 53, 69, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(40, 167, 69, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Grade Distribution Chart
const gradeDistributionCtx = document.getElementById('gradeDistributionChart').getContext('2d');
const gradeDistributionChart = new Chart(gradeDistributionCtx, {
    type: 'pie',
    data: {
        labels: ['A (90-100)', 'B (80-89)', 'C (70-79)', 'D (60-69)', 'F (Below 60)'],
        datasets: [{
            data: [122, 146, 97, 73, 48],
            backgroundColor: [
                'rgba(40, 167, 69, 0.8)',
                'rgba(23, 162, 184, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(255, 152, 0, 0.8)',
                'rgba(220, 53, 69, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Attendance Impact Chart
const attendanceImpactCtx = document.getElementById('attendanceImpactChart').getContext('2d');
const attendanceImpactChart = new Chart(attendanceImpactCtx, {
    type: 'scatter',
    data: {
        datasets: [{
            label: 'Students',
            data: [
                {x: 95, y: 3.8}, {x: 92, y: 3.6}, {x: 88, y: 3.4}, {x: 85, y: 3.2},
                {x: 82, y: 3.0}, {x: 78, y: 2.8}, {x: 75, y: 2.6}, {x: 70, y: 2.4},
                {x: 65, y: 2.2}, {x: 60, y: 2.0}, {x: 55, y: 1.8}, {x: 50, y: 1.6}
            ],
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Attendance Rate (%)'
                },
                min: 40,
                max: 100
            },
            y: {
                title: {
                    display: true,
                    text: 'GPA'
                },
                min: 1.0,
                max: 4.0
            }
        }
    }
});

// Functions
function applyFilters() {
    const semester = document.getElementById('semesterFilter').value;
    const department = document.getElementById('departmentFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const riskLevel = document.getElementById('riskLevelFilter').value;
    const performance = document.getElementById('performanceFilter').value;
    
    console.log('Applying filters:', { semester, department, startDate, endDate, riskLevel, performance });
    
    // This would fetch filtered data from the API
    alert('Filters applied successfully!');
}

function exportReport(type) {
    console.log('Exporting report:', type);
    alert(`Exporting ${type} report...`);
}

function exportDetailedReport() {
    alert('Exporting detailed analytics report...');
}

// Load analytics data
function loadAnalyticsData() {
    // This would fetch data from the API
    console.log('Loading analytics data...');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
    
    // Set today's date as default end date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('endDate').value = today;
    
    // Set 3 months ago as default start date
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];
});
</script>
{% endblock %}
